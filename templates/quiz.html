<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz - SmartCourseQA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <h1><i class="bi bi-robot"></i> SmartCourseQA</h1>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class="bi bi-house"></i> Accueil
                </a>
                <a href="/chatbot" class="nav-link">
                    <i class="bi bi-chat-dots"></i> Chatbot
                </a>
                <a href="/quiz" class="nav-link active">
                    <i class="bi bi-clipboard-check"></i> Quiz
                </a>
            </div>
        </nav>

        <div class="quiz-container">
            <!-- Génération de quiz -->
            <div id="quiz-generator" class="quiz-section">
                <div class="quiz-header">
                    <h2><i class="bi bi-clipboard-plus"></i> Générer un Quiz</h2>
                    <p class="subtitle">Créez un quiz personnalisé basé sur vos cours</p>
                </div>

                <form id="generate-quiz-form">
                    <div class="form-group">
                        <label for="quiz-topic">
                            <i class="bi bi-bookmark"></i> Sujet du quiz:
                        </label>
                        <input 
                            type="text" 
                            id="quiz-topic" 
                            placeholder="Ex: intelligence artificielle, machine learning..."
                            value="intelligence artificielle"
                            required
                        >
                    </div>

                    <button type="submit" class="btn-primary" id="generate-btn">
                        <i class="bi bi-dice-5" id="gen-icon"></i>
                        <i class="bi bi-hourglass-split" id="gen-loading" style="display: none;"></i>
                        <span id="gen-text">Générer 5 Questions</span>
                    </button>
                </form>
            </div>

            <!-- Quiz affiché -->
            <div id="quiz-display" class="quiz-section" style="display: none;">
                <div class="quiz-header">
                    <h2><i class="bi bi-list-check"></i> Répondez au Quiz</h2>
                    <p class="subtitle" id="quiz-topic-display"></p>
                </div>

                <form id="quiz-form">
                    <div id="questions-container"></div>

                    <div class="quiz-actions">
                        <button type="submit" class="btn-primary">
                            <i class="bi bi-check-circle"></i> Soumettre mes réponses
                        </button>
                        <button type="button" class="btn-secondary" id="new-quiz-btn">
                            <i class="bi bi-arrow-repeat"></i> Nouveau Quiz
                        </button>
                    </div>
                </form>
            </div>

            <!-- Résultats -->
            <div id="quiz-results" class="quiz-section" style="display: none;">
                <div class="quiz-header">
                    <h2><i class="bi bi-trophy"></i> Résultats du Quiz</h2>
                </div>

                <div class="score-display">
                    <div class="score-circle">
                        <span id="score-percentage">0%</span>
                    </div>
                    <p id="score-text"></p>
                </div>

                <div id="results-details"></div>

                <div class="quiz-actions">
                    <button type="button" class="btn-primary" id="retry-quiz-btn">
                        <i class="bi bi-arrow-repeat"></i> Refaire le Quiz
                    </button>
                    <button type="button" class="btn-secondary" id="generate-new-btn">
                        <i class="bi bi-dice-5"></i> Générer un Nouveau Quiz
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const generateForm = document.getElementById('generate-quiz-form');
        const quizForm = document.getElementById('quiz-form');
        const quizGenerator = document.getElementById('quiz-generator');
        const quizDisplay = document.getElementById('quiz-display');
        const quizResults = document.getElementById('quiz-results');
        const questionsContainer = document.getElementById('questions-container');
        const resultsDetails = document.getElementById('results-details');
        const genBtn = document.getElementById('generate-btn');
        const genIcon = document.getElementById('gen-icon');
        const genLoading = document.getElementById('gen-loading');
        const genText = document.getElementById('gen-text');

        let currentQuiz = null;

        // Générer un quiz (toujours 5 questions)
        generateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const topic = document.getElementById('quiz-topic').value.trim();
            const numQuestions = 5; // Fixé à 5 questions

            setGenerating(true);

            try {
                const response = await fetch('/api/generate-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ topic, num_questions: numQuestions })
                });

                const data = await response.json();

                if (response.ok) {
                    currentQuiz = data.questions;
                    displayQuiz(data.questions, data.topic);
                } else {
                    alert(`Erreur: ${data.error}`);
                }
            } catch (error) {
                alert(`Erreur de connexion: ${error.message}`);
            } finally {
                setGenerating(false);
            }
        });

        // Soumettre les réponses
        quizForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const answers = {};
            const formData = new FormData(quizForm);

            for (let [key, value] of formData.entries()) {
                const questionIndex = key.replace('question-', '');
                answers[questionIndex] = value;
            }

            try {
                const response = await fetch('/api/evaluate-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ answers })
                });

                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    alert(`Erreur: ${data.error}`);
                }
            } catch (error) {
                alert(`Erreur de connexion: ${error.message}`);
            }
        });

        // Boutons de navigation
        document.getElementById('new-quiz-btn').addEventListener('click', () => {
            showSection('generator');
        });

        document.getElementById('retry-quiz-btn').addEventListener('click', () => {
            if (currentQuiz) {
                displayQuiz(currentQuiz, document.getElementById('quiz-topic').value);
            }
        });

        document.getElementById('generate-new-btn').addEventListener('click', () => {
            showSection('generator');
        });

        function displayQuiz(questions, topic) {
            document.getElementById('quiz-topic-display').innerHTML = `<i class="bi bi-tag"></i> Sujet: ${topic}`;
            questionsContainer.innerHTML = '';

            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-block';
                questionDiv.innerHTML = `
                    <h3><i class="bi bi-question-circle"></i> Question ${index + 1}</h3>
                    <p class="question-text">${escapeHtml(q.question)}</p>
                    <div class="options">
                        ${Object.entries(q.options).map(([letter, text]) => `
                            <label class="option-label">
                                <input 
                                    type="radio" 
                                    name="question-${index}" 
                                    value="${letter}"
                                    required
                                >
                                <span class="option-text">
                                    <strong>${letter})</strong> ${escapeHtml(text)}
                                </span>
                            </label>
                        `).join('')}
                    </div>
                `;
                questionsContainer.appendChild(questionDiv);
            });

            showSection('quiz');
        }

        function displayResults(data) {
            const { score, correct_count, total_questions, results } = data;

            // Afficher le score
            document.getElementById('score-percentage').textContent = `${Math.round(score)}%`;
            document.getElementById('score-text').innerHTML = `
                <i class="bi bi-check-circle-fill" style="color: var(--success-color);"></i>
                Vous avez répondu correctement à ${correct_count} sur ${total_questions} questions
            `;

            // Détails des résultats
            resultsDetails.innerHTML = results.map((result, index) => `
                <div class="result-item ${result.is_correct ? 'correct' : 'incorrect'}">
                    <div class="result-header">
                        <span class="result-icon">
                            ${result.is_correct 
                                ? '<i class="bi bi-check-circle-fill" style="color: var(--success-color);"></i>' 
                                : '<i class="bi bi-x-circle-fill" style="color: var(--danger-color);"></i>'}
                        </span>
                        <h4>Question ${index + 1}</h4>
                    </div>
                    <p class="result-question">${escapeHtml(result.question)}</p>
                    <div class="result-answers">
                        <p>
                            <strong>Votre réponse:</strong> 
                            <span class="${result.is_correct ? 'correct-answer' : 'wrong-answer'}">
                                ${result.user_answer || 'Pas de réponse'}
                            </span>
                        </p>
                        ${!result.is_correct ? `
                            <p>
                                <strong>Réponse correcte:</strong> 
                                <span class="correct-answer">${result.correct_answer}</span>
                            </p>
                        ` : ''}
                    </div>
                    ${result.explanation ? `
                        <div class="result-explanation">
                            <strong><i class="bi bi-lightbulb"></i> Explication:</strong> ${escapeHtml(result.explanation)}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            showSection('results');
        }

        function showSection(section) {
            quizGenerator.style.display = section === 'generator' ? 'block' : 'none';
            quizDisplay.style.display = section === 'quiz' ? 'block' : 'none';
            quizResults.style.display = section === 'results' ? 'block' : 'none';
        }

        function setGenerating(isGenerating) {
            genBtn.disabled = isGenerating;
            
            if (isGenerating) {
                genIcon.style.display = 'none';
                genLoading.style.display = 'inline';
                genText.textContent = 'Génération en cours...';
            } else {
                genIcon.style.display = 'inline';
                genLoading.style.display = 'none';
                genText.textContent = 'Générer 5 Questions';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
